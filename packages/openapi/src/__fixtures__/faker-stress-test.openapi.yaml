openapi: 3.0.3
info:
  title: Data Faker Stress Test API
  description: |
    A synthetic OpenAPI spec designed to exercise every tricky schema feature
    that a data faker / mock generator must handle correctly. This is NOT a real
    API — it exists purely as a conformance test for fake-data generators.

    ## Coverage checklist
    - oneOf / anyOf / allOf with discriminators
    - Recursive / self-referencing schemas
    - Regex patterns & string formats (email, uri, uuid, ipv4, ipv6, date-time, date, byte, binary)
    - Numeric constraints (min, max, exclusiveMin/Max, multipleOf)
    - String constraints (minLength, maxLength, pattern)
    - Array constraints (minItems, maxItems, uniqueItems)
    - Enums (string, integer)
    - Nullable fields
    - readOnly / writeOnly
    - additionalProperties (boolean & schema-typed)
    - Free-form objects
    - Default values
    - Deep $ref chains
    - Maps / dictionaries
    - Empty schema (any type)
    - Nested oneOf inside allOf
    - Const-like single-value enums
  version: 1.0.0
  license:
    name: MIT

servers:
  - url: https://faker-test.localhost/api/v1

tags:
  - name: Nodes
    description: Recursive tree structures
  - name: Events
    description: Polymorphic event log
  - name: Profiles
    description: Constrained user profiles
  - name: Matrices
    description: Numeric edge cases
  - name: Blobs
    description: Binary and encoded payloads

paths:
  # ── Recursive tree ────────────────────────────────────────────────
  /nodes:
    post:
      tags: [Nodes]
      operationId: createNode
      summary: Create a recursive tree node
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TreeNode'
      responses:
        '201':
          description: Created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TreeNode'
        '422':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationErrorBatch'

  # ── Polymorphic events ────────────────────────────────────────────
  /events:
    get:
      tags: [Events]
      operationId: listEvents
      summary: List polymorphic events (oneOf + discriminator)
      parameters:
        - $ref: '#/components/parameters/PageOffset'
        - $ref: '#/components/parameters/PageLimit'
        - name: severity
          in: query
          required: false
          schema:
            $ref: '#/components/schemas/SeverityEnum'
      responses:
        '200':
          description: Paginated event list
          headers:
            X-Total-Count:
              schema:
                type: integer
                minimum: 0
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EventPage'

    post:
      tags: [Events]
      operationId: createEvent
      summary: Create an event (discriminated union)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/EventEnvelope'
      responses:
        '201':
          description: Created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EventEnvelope'

  # ── Constrained profile ──────────────────────────────────────────
  /profiles:
    post:
      tags: [Profiles]
      operationId: createProfile
      summary: Create a heavily-constrained user profile
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UserProfile'
      responses:
        '201':
          description: Created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserProfile'

  /profiles/{profileId}:
    get:
      tags: [Profiles]
      operationId: getProfile
      parameters:
        - name: profileId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserProfile'

  # ── Numeric matrices ─────────────────────────────────────────────
  /matrices:
    post:
      tags: [Matrices]
      operationId: submitMatrix
      summary: Submit a constrained numeric matrix
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/NumericMatrix'
      responses:
        '200':
          description: Processed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MatrixResult'

  # ── Binary blobs ─────────────────────────────────────────────────
  /blobs:
    post:
      tags: [Blobs]
      operationId: uploadBlob
      summary: Upload mixed binary and metadata
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              $ref: '#/components/schemas/BlobUpload'
          application/octet-stream:
            schema:
              type: string
              format: binary
      responses:
        '201':
          description: Stored
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BlobMeta'

  # ── Kitchen sink (anyOf body) ────────────────────────────────────
  /actions:
    post:
      tags: [Events]
      operationId: performAction
      summary: Accepts multiple shape variants via anyOf
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ActionRequest'
      responses:
        '200':
          description: Result depends on variant
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ActionResult'

# ════════════════════════════════════════════════════════════════════
# COMPONENTS
# ════════════════════════════════════════════════════════════════════
components:

  # ── Parameters ───────────────────────────────────────────────────
  parameters:
    PageOffset:
      name: offset
      in: query
      required: false
      schema:
        type: integer
        minimum: 0
        default: 0
    PageLimit:
      name: limit
      in: query
      required: false
      schema:
        type: integer
        minimum: 1
        maximum: 100
        default: 20

  # ── Schemas ──────────────────────────────────────────────────────
  schemas:

    # ·· Enums ····················································
    SeverityEnum:
      type: string
      enum: [debug, info, warning, error, critical]

    StatusCodeEnum:
      type: integer
      enum: [100, 200, 301, 400, 403, 404, 500, 502, 503]

    # ·· Recursive tree ···········································
    TreeNode:
      type: object
      required: [id, label]
      properties:
        id:
          type: string
          format: uuid
          readOnly: true
        label:
          type: string
          minLength: 1
          maxLength: 120
        weight:
          type: number
          format: double
          minimum: 0.0
          maximum: 1.0
          default: 0.5
        tags:
          type: array
          items:
            type: string
            pattern: '^[a-z][a-z0-9_-]{0,31}$'
          minItems: 0
          maxItems: 10
          uniqueItems: true
        metadata:
          description: Free-form key→value bag
          type: object
          additionalProperties:
            type: string
        children:
          type: array
          description: Recursive — each child is also a TreeNode
          items:
            $ref: '#/components/schemas/TreeNode'
          maxItems: 50

    # ·· Polymorphic events (oneOf + discriminator) ················
    EventEnvelope:
      type: object
      required: [eventType, timestamp, payload]
      properties:
        eventType:
          type: string
        timestamp:
          type: string
          format: date-time
        correlationId:
          type: string
          format: uuid
          nullable: true
        payload:
          $ref: '#/components/schemas/EventPayload'

    EventPayload:
      oneOf:
        - $ref: '#/components/schemas/HttpRequestEvent'
        - $ref: '#/components/schemas/MetricEvent'
        - $ref: '#/components/schemas/DeploymentEvent'
        - $ref: '#/components/schemas/AuditEvent'
      discriminator:
        propertyName: kind
        mapping:
          http_request: '#/components/schemas/HttpRequestEvent'
          metric: '#/components/schemas/MetricEvent'
          deployment: '#/components/schemas/DeploymentEvent'
          audit: '#/components/schemas/AuditEvent'

    HttpRequestEvent:
      type: object
      required: [kind, method, path, statusCode, durationMs]
      properties:
        kind:
          type: string
          enum: [http_request]
        method:
          type: string
          enum: [GET, POST, PUT, PATCH, DELETE, HEAD, OPTIONS]
        path:
          type: string
          pattern: '^/[a-zA-Z0-9/_-]*$'
          maxLength: 2048
        statusCode:
          $ref: '#/components/schemas/StatusCodeEnum'
        durationMs:
          type: number
          format: float
          minimum: 0
          exclusiveMaximum: true
          maximum: 300000
        headers:
          type: object
          additionalProperties:
            type: string
          description: Arbitrary header map
        clientIp:
          type: string
          oneOf:
            - format: ipv4
            - format: ipv6

    MetricEvent:
      type: object
      required: [kind, name, value, unit]
      properties:
        kind:
          type: string
          enum: [metric]
        name:
          type: string
          pattern: '^[a-z][a-z0-9_.]{0,127}$'
        value:
          type: number
          format: double
        unit:
          type: string
          enum: [ms, bytes, percent, count, rpm]
        dimensions:
          type: object
          additionalProperties:
            type: string
          maxProperties: 10
        percentiles:
          type: object
          description: Map of percentile label → value
          additionalProperties:
            type: number
            format: double
          example:
            p50: 12.5
            p95: 87.3
            p99: 142.0

    DeploymentEvent:
      type: object
      required: [kind, environment, version, status]
      properties:
        kind:
          type: string
          enum: [deployment]
        environment:
          type: string
          enum: [dev, staging, production]
        version:
          type: string
          description: SemVer string
          pattern: '^\d+\.\d+\.\d+(-[a-zA-Z0-9.]+)?(\+[a-zA-Z0-9.]+)?$'
        status:
          type: string
          enum: [pending, in_progress, succeeded, failed, rolled_back]
        changedServices:
          type: array
          items:
            type: string
            minLength: 1
          minItems: 1
          maxItems: 50
        rollbackTarget:
          type: string
          pattern: '^\d+\.\d+\.\d+(-[a-zA-Z0-9.]+)?(\+[a-zA-Z0-9.]+)?$'
          nullable: true

    AuditEvent:
      type: object
      required: [kind, actor, action, resource]
      properties:
        kind:
          type: string
          enum: [audit]
        actor:
          $ref: '#/components/schemas/ActorRef'
        action:
          type: string
          enum: [create, read, update, delete, grant, revoke, login, logout]
        resource:
          $ref: '#/components/schemas/ResourceRef'
        diff:
          description: Before/after snapshot (nullable, free-form)
          nullable: true
          type: object
          properties:
            before:
              type: object
              additionalProperties: true
            after:
              type: object
              additionalProperties: true

    ActorRef:
      type: object
      required: [id, type]
      properties:
        id:
          type: string
          format: uuid
        type:
          type: string
          enum: [user, service_account, api_key]
        displayName:
          type: string
          maxLength: 256

    ResourceRef:
      type: object
      required: [urn]
      properties:
        urn:
          type: string
          description: 'Uniform resource name like urn:service:type:id'
          pattern: '^urn:[a-z0-9-]+:[a-z0-9-]+:[a-zA-Z0-9_-]+$'
        href:
          type: string
          format: uri
          nullable: true

    EventPage:
      type: object
      required: [items, total, offset, limit]
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/EventEnvelope'
        total:
          type: integer
          minimum: 0
        offset:
          type: integer
          minimum: 0
        limit:
          type: integer
          minimum: 1
          maximum: 100

    # ·· Constrained user profile ·································
    UserProfile:
      type: object
      required: [username, email, role, settings]
      properties:
        id:
          type: string
          format: uuid
          readOnly: true
        username:
          type: string
          minLength: 3
          maxLength: 32
          pattern: '^[a-zA-Z][a-zA-Z0-9_-]{2,31}$'
        email:
          type: string
          format: email
          maxLength: 254
        role:
          type: string
          enum: [viewer, editor, admin, superadmin]
        avatarUrl:
          type: string
          format: uri
          nullable: true
        bio:
          type: string
          maxLength: 2000
          default: ''
        dateOfBirth:
          type: string
          format: date
          nullable: true
        settings:
          $ref: '#/components/schemas/ProfileSettings'
        addresses:
          type: array
          items:
            $ref: '#/components/schemas/Address'
          maxItems: 5
        password:
          type: string
          writeOnly: true
          minLength: 12
          maxLength: 128
          pattern: '^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[!@#$%^&*]).{12,128}$'
        createdAt:
          type: string
          format: date-time
          readOnly: true
        updatedAt:
          type: string
          format: date-time
          readOnly: true

    ProfileSettings:
      type: object
      required: [locale, timezone, theme]
      properties:
        locale:
          type: string
          description: 'BCP-47 language tag'
          pattern: '^[a-z]{2,3}(-[A-Z]{2})?$'
          default: 'en-US'
        timezone:
          type: string
          description: 'IANA timezone identifier'
          pattern: '^[A-Z][a-zA-Z]+/[A-Z][a-zA-Z_]+$'
          example: 'Europe/Zurich'
        theme:
          type: string
          enum: [light, dark, system]
          default: system
        notifications:
          $ref: '#/components/schemas/NotificationPrefs'

    NotificationPrefs:
      type: object
      properties:
        emailDigest:
          type: string
          enum: [none, daily, weekly]
          default: weekly
        pushEnabled:
          type: boolean
          default: true
        quietHoursStart:
          type: string
          description: 'HH:MM in 24h format'
          pattern: '^([01]\d|2[0-3]):([0-5]\d)$'
          nullable: true
        quietHoursEnd:
          type: string
          pattern: '^([01]\d|2[0-3]):([0-5]\d)$'
          nullable: true
        channels:
          type: array
          items:
            type: string
            enum: [email, sms, push, slack, webhook]
          uniqueItems: true
          minItems: 1
          maxItems: 5

    Address:
      type: object
      required: [line1, city, countryCode]
      properties:
        line1:
          type: string
          minLength: 1
          maxLength: 200
        line2:
          type: string
          maxLength: 200
          nullable: true
        city:
          type: string
          minLength: 1
          maxLength: 100
        stateOrProvince:
          type: string
          maxLength: 100
          nullable: true
        postalCode:
          type: string
          pattern: '^\d{4,10}$'
          nullable: true
        countryCode:
          type: string
          description: 'ISO 3166-1 alpha-2'
          pattern: '^[A-Z]{2}$'
          minLength: 2
          maxLength: 2

    # ·· Numeric matrix edge cases ································
    NumericMatrix:
      type: object
      required: [label, rows]
      properties:
        label:
          type: string
          minLength: 1
        rows:
          type: array
          items:
            $ref: '#/components/schemas/MatrixRow'
          minItems: 1
          maxItems: 100
        precision:
          type: integer
          minimum: 0
          maximum: 15
          default: 6
          description: Decimal places for display
        constraints:
          $ref: '#/components/schemas/CellConstraints'

    MatrixRow:
      type: object
      required: [cells]
      properties:
        rowLabel:
          type: string
          nullable: true
        cells:
          type: array
          items:
            $ref: '#/components/schemas/MatrixCell'
          minItems: 1
          maxItems: 500

    MatrixCell:
      oneOf:
        - $ref: '#/components/schemas/NumericCell'
        - $ref: '#/components/schemas/FormulaCell'
        - $ref: '#/components/schemas/EmptyCell'

    NumericCell:
      type: object
      required: [type, value]
      properties:
        type:
          type: string
          enum: [numeric]
        value:
          type: number
          format: double
        formatted:
          type: string
          readOnly: true

    FormulaCell:
      type: object
      required: [type, expression]
      properties:
        type:
          type: string
          enum: [formula]
        expression:
          type: string
          description: 'Infix expression referencing cell addresses like A1, B2'
          pattern: '^[A-Z]+\d+([\s]*[+\-*/]\s*[A-Z]+\d+)*$'
        cachedValue:
          type: number
          format: double
          nullable: true
          readOnly: true

    EmptyCell:
      type: object
      required: [type]
      properties:
        type:
          type: string
          enum: [empty]

    CellConstraints:
      type: object
      description: Optional per-matrix value constraints
      properties:
        minValue:
          type: number
          format: double
          nullable: true
        maxValue:
          type: number
          format: double
          nullable: true
        multipleOf:
          type: number
          format: double
          exclusiveMinimum: true
          minimum: 0
          nullable: true
          description: 'Every numeric cell must be a multiple of this value'
        allowNegative:
          type: boolean
          default: true

    MatrixResult:
      type: object
      required: [checksum, stats]
      properties:
        checksum:
          type: string
          pattern: '^[a-f0-9]{64}$'
          description: SHA-256 of the serialized matrix
        stats:
          type: object
          required: [cellCount, numericCount, formulaCount, emptyCount, sum, mean]
          properties:
            cellCount:
              type: integer
              minimum: 0
            numericCount:
              type: integer
              minimum: 0
            formulaCount:
              type: integer
              minimum: 0
            emptyCount:
              type: integer
              minimum: 0
            sum:
              type: number
              format: double
            mean:
              type: number
              format: double
              nullable: true
            stddev:
              type: number
              format: double
              nullable: true

    # ·· Binary upload ············································
    BlobUpload:
      type: object
      required: [file, checksum]
      properties:
        file:
          type: string
          format: binary
        thumbnail:
          type: string
          format: byte
          description: Base64-encoded thumbnail preview
          nullable: true
        checksum:
          type: string
          description: 'SHA-256 hex digest of the file'
          pattern: '^[a-f0-9]{64}$'
        tags:
          type: array
          items:
            type: string
            minLength: 1
            maxLength: 50
          uniqueItems: true
          maxItems: 20

    BlobMeta:
      type: object
      required: [id, sizeBytes, mimeType, createdAt]
      properties:
        id:
          type: string
          format: uuid
        sizeBytes:
          type: integer
          format: int64
          minimum: 0
        mimeType:
          type: string
          pattern: '^[a-z]+/[a-z0-9.+-]+$'
        createdAt:
          type: string
          format: date-time
        expiresAt:
          type: string
          format: date-time
          nullable: true
        downloadUrl:
          type: string
          format: uri

    # ·· anyOf kitchen sink ·······································
    ActionRequest:
      type: object
      required: [action]
      properties:
        action:
          anyOf:
            - $ref: '#/components/schemas/SendEmailAction'
            - $ref: '#/components/schemas/WebhookAction'
            - $ref: '#/components/schemas/TransformAction'
        idempotencyKey:
          type: string
          format: uuid
        dryRun:
          type: boolean
          default: false
        scheduledAt:
          type: string
          format: date-time
          nullable: true

    SendEmailAction:
      type: object
      required: [type, to, subject, body]
      properties:
        type:
          type: string
          enum: [send_email]
        to:
          type: array
          items:
            type: string
            format: email
          minItems: 1
          maxItems: 50
        cc:
          type: array
          items:
            type: string
            format: email
          maxItems: 20
          default: []
        subject:
          type: string
          minLength: 1
          maxLength: 998
        body:
          type: string
          minLength: 1
          maxLength: 100000

    WebhookAction:
      type: object
      required: [type, url, method]
      properties:
        type:
          type: string
          enum: [webhook]
        url:
          type: string
          format: uri
        method:
          type: string
          enum: [GET, POST, PUT, PATCH]
        headers:
          type: object
          additionalProperties:
            type: string
        payload:
          description: Arbitrary JSON body
          nullable: true
          oneOf:
            - type: object
              additionalProperties: true
            - type: array
              items: {}
            - type: string
        retryPolicy:
          $ref: '#/components/schemas/RetryPolicy'

    TransformAction:
      type: object
      required: [type, input, pipeline]
      properties:
        type:
          type: string
          enum: [transform]
        input:
          description: Any valid JSON value
          oneOf:
            - type: string
            - type: number
            - type: integer
            - type: boolean
            - type: object
              additionalProperties: true
            - type: array
              items: {}
        pipeline:
          type: array
          description: Ordered list of transformation steps
          items:
            $ref: '#/components/schemas/TransformStep'
          minItems: 1
          maxItems: 20

    TransformStep:
      type: object
      required: [op]
      properties:
        op:
          type: string
          enum: [map, filter, reduce, sort, distinct, take, skip, flatten]
        expression:
          type: string
          description: JSONPath or jq-style expression
          nullable: true
        params:
          type: object
          additionalProperties: true
          description: Op-specific params (free-form)

    RetryPolicy:
      type: object
      properties:
        maxRetries:
          type: integer
          minimum: 0
          maximum: 10
          default: 3
        initialDelayMs:
          type: integer
          minimum: 100
          maximum: 60000
          default: 1000
        backoffMultiplier:
          type: number
          format: float
          minimum: 1.0
          maximum: 5.0
          default: 2.0
        retryOn:
          type: array
          items:
            type: integer
            description: HTTP status codes that trigger retry
            minimum: 400
            maximum: 599
          uniqueItems: true
          default: [500, 502, 503, 504]

    ActionResult:
      type: object
      required: [requestId, status]
      properties:
        requestId:
          type: string
          format: uuid
        status:
          type: string
          enum: [accepted, completed, failed, scheduled]
        completedAt:
          type: string
          format: date-time
          nullable: true
        output:
          description: Free-form result payload
          nullable: true
        errors:
          type: array
          items:
            $ref: '#/components/schemas/ErrorDetail'
          default: []

    # ·· Shared error schemas ·····································
    ErrorDetail:
      type: object
      required: [code, message]
      properties:
        code:
          type: string
          pattern: '^[A-Z_]{3,50}$'
        message:
          type: string
          maxLength: 1000
        field:
          type: string
          nullable: true
          description: 'JSON pointer to the offending field'
          pattern: '^(/[a-zA-Z0-9_~]+)+$'
        meta:
          type: object
          additionalProperties: true
          nullable: true

    ValidationErrorBatch:
      type: object
      required: [status, errors]
      properties:
        status:
          type: integer
          enum: [422]
        traceId:
          type: string
          pattern: '^[a-f0-9]{32}$'
        errors:
          type: array
          items:
            $ref: '#/components/schemas/ErrorDetail'
          minItems: 1
